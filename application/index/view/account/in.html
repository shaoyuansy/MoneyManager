{layout name="layout"}
<head>
    <link href="/static/css/account.css" rel="stylesheet">
</head>
<section id="main-content">
	<section class="wrapper">
		<h3><i class="fa fa-angle-right"></i> 收入</h3>
		<!-- BASIC FORM ELELEMNTS -->
		<div class="row mt">
			<div class="col-lg-12 col-md-12 col-sm-12">
				<div class="content-panel">
					<form class="form-horizontal style-form row" id="income-form">
						<div class="col-lg-3 col-md-3 col-sm-12" style="padding-left:0px;padding-right:0px;">
							<p class="centered" style="margin:0px;">
								<img src="/static/img/ui-sam.jpg" class="img-circle">
							</p>
						</div>
						<div class="row col-lg-9 col-md-9 col-sm-12 in-filters" >
							<div class="form-group in-filter row col-lg-4 col-md-4 col-sm-12" 
								 style="border-bottom: 0px;padding-bottom: 0px;margin-bottom: 0px;margin-right: 0px; margin-left: 0px;">
								<label class="col-lg-3 col-md-3 col-sm-2 control-label" style="padding-top: 3px;padding-right: 0px;padding-left: 0px;text-align: right;">
								分类</label>
								<div class="col-lg-9 col-md-9 col-sm-10">
									<select class="form-control select intype" id="type" name="type">
									</select>
								</div>
							</div>
							<div class="form-group in-filter row col-lg-4 col-md-4 col-sm-12" 
								 style="border-bottom: 0px;padding-bottom: 0px;margin-bottom: 0px;margin-right: 0px; margin-left: 0px;">
								<label class="col-lg-3 col-md-3 col-sm-2 control-label" style="padding-top: 3px;padding-right: 0px;padding-left: 0px;text-align: right;">
								账户</label>
								<div class="col-lg-9 col-md-9 col-sm-10">
									<select class="form-control select accounttype" id="account" name="account">
									</select>
								</div>
							</div>
							<div class="form-group in-filter row col-lg-4 col-md-4 col-sm-12" 
								 style="border-bottom: 0px;padding-bottom: 0px;margin-bottom: 0px;margin-right: 0px; margin-left: 0px;">
								<label class="col-lg-3 col-md-3 col-sm-2 control-label" style="padding-top: 3px;padding-right: 0px;padding-left: 0px;text-align: right;">
								金额</label>
								<div class="col-lg-9 col-md-9 col-sm-10">
									<div class="input-group">
										<span style="padding:0px 7px;" class="input-group-addon">￥</span>
										<input type="number" min="0" class="form-control" id="money" name="money" onblur="vali_money()"
										data-container="body" data-toggle="popover" data-trigger="manual" data-placement="bottom">
									</div>
								</div>
							</div>
							<div class="form-group in-filter row col-lg-4 col-md-4 col-sm-12" 
								 style="border-bottom: 0px;padding-bottom: 0px;margin-bottom: 0px;margin-right: 0px; margin-left: 0px;">
								<label class="col-lg-3 col-md-3 col-sm-2 control-label" style="padding-top: 3px;padding-right: 0px;padding-left: 0px;text-align: right;">
								成员</label>
								<div class="col-lg-9 col-md-9 col-sm-10">
									<select class="form-control select membertype" id="member" name="member">
									</select>
								</div>
							</div>
							<div class="form-group in-filter row col-lg-4 col-md-4 col-sm-12" 
								 style="border-bottom: 0px;padding-bottom: 0px;margin-bottom: 0px;margin-right: 0px; margin-left: 0px;">
								<label class="col-lg-3 col-md-3 col-sm-2 control-label" style="padding-top: 3px;padding-right: 0px;padding-left: 0px;text-align: right;">
								时间</label>
								<div class="col-lg-9 col-md-9 col-sm-10 ">
									<div class="input-group">
										<input type="text" class="form-control" id="time" name="time" onblur="vali_time()"
										data-container="body" data-toggle="popover" data-trigger="manual" data-placement="bottom">
										<span style="padding:0px 7px;" class="input-group-addon">
											<label for="time"><i class="fa fa-calendar"></i></label>
										</span>
									</div>
								</div>
							</div>
							<div class="form-group row in-filter col-lg-12 col-md-12 col-sm-12" 
								 style="border-bottom: 0px;padding-bottom: 0px;margin-bottom: 0px;margin-right: 0px; margin-left: 0px;">
								<label class="col-lg-1 col-md-1 col-sm-2 control-label" style="padding-top: 3px;padding-right: 0px;padding-left: 0px;text-align: right;">
								备注</label>
								<div class="col-lg-11 col-md-11 col-sm-10">
									<input type="text" class="form-control" id="remark" name="remark" onblur="vali_remark()"
									data-container="body" data-toggle="popover" data-trigger="manual" data-placement="bottom">
								</div>
							</div>
							<div class="col-lg-12 col-md-12 col-sm-12" style="position:relative;height:40px;" >
								<button type="button" class="btn btn-warning save-in" onclick="save()">保存</button>									
							</div>
						</div>
					</form>
					<hr><!-- 条件填写完成-->
					<div class="row" style="padding:20px;">
						<div class="row col-lg-6 col-md-6 col-sm-12" style="position:relative;height:50px;">
							<div class="col-lg-4 col-md-4 col-sm-3">
								<h4 style="margin-left: 0px;">收入清单</h4>
							</div>								
						</div>
						<div class="row col-lg-12 col-md-12 col-sm-12" style="margin:0px;">
							<table id="example" class="display table table-hover table-striped table-bordered" cellspacing="0" width="100%">
								<thead>
									<tr>
										<th>#</th>
										<th>收入类型</th>
										<th>账户</th>
										<th>时间</th>
										<th>金额</th>
										<th>成员</th>
										<th>备注</th>
									</tr>
									<tr>
										<th> </th>
										<th> </th>
										<th> </th>
										<th> </th>
										<th> </th>
										<th> </th>
										<th> </th>
									</tr>
								</thead>
								<tfoot>
									<tr>
										<td colspan="7" style="text-align:right">Total:</td>
									</tr>
								</tfoot>
							</table>
						</div>
					</div>
				</div>
			</div>
			<div class="modal fade" id="success" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
				<div class="modal-dialog" style="width: 300px;">
					<div class="modal-content" style="margin-top:200px;">
						<div class="modal-header" style="padding:5px;padding-left:10px;border-top-left-radius:5px;border-top-right-radius:5px;">
							<button type="button" class="close" data-dismiss="modal" aria-hidden="true">
								&times;
							</button>
							<h4 class="modal-title" style="font-size:15px;">
								提示
							</h4>
						</div>
						<div class="modal-body" style="text-align:center;height:70px;padding-top:30px;">
							操作成功
						</div>
						<div class="modal-footer" style="padding: 5px;text-align: center">
							<button type="button" class="btn btn-default btn-sm" data-dismiss="modal">确定</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</section>
</section>
	
<script type="text/javascript">
	$(function() {	
		//获取收入分类
		$.ajax({
			type: "get",
			url: '/index/account/in_type',
			async: false,
			success: function (msg) {
				if(msg.success){
					var in_type = JSON.parse(msg.data.type);
					var typeStr = "";
					in_type.type.forEach(function(item){
						typeStr += "<option>"+ item +"</option>";
					});
					$(".intype").html(typeStr);
				}
			},
			error: function (e) {
				console.log(e);
			}
		});
		//获取账户分类
		$.ajax({
			type: "get",
			url: '/index/account/account_type',
			async: false,
			success: function (msg) {
				if(msg.success){
					var account_type = JSON.parse(msg.data.type);
					var typeStr = "";
					account_type.type.forEach(function(item){
						if(item=="债权账户")
							return true;
						typeStr += "<option>"+ item +"</option>";
					});
					$(".accounttype").html(typeStr);
				}
			},
			error: function (e) {
				console.log(e);
			}
		});
		//获取成员
		$.ajax({
			type: "get",
			url: '/index/account/member_type',
			async: false,
			success: function (msg) {
				if(msg.success){
					var member_type = JSON.parse(msg.data.type);
					var typeStr = "";
					member_type.type.forEach(function(item){
						typeStr += "<option>"+ item +"</option>";
					});
					$(".membertype").html(typeStr);
				}
			},
			error: function (e) {
				console.log(e);
			}
		});
		
		$('#time').datetimepicker({
			format: 'yyyy-mm-dd hh:ii',
			language:'zh-CN',
			todayBtn:'linked'
		});

		buildTable();
		
	});	
	
	//提交
	function save(){
		var type = $("#type").val();
		var account = $("#account").val();
		var money = $("#money").val();
		var time = $("#time").val();
		var member = $("#member").val();
		var remark = $("#remark").val();
		if(vali_money() && vali_time() && vali_remark()){
			$.ajax({
				type: "post",
				url: '/index/account/set_income',
				dataType: "json",
				data: {type:type,account:account,money:money,time:time,member:member,remark:remark},
				cache: true,
				async: false,
				success: function (msg) {
					if(msg.success){
						$("#success").modal({backdrop:false});
						setTimeout(function(){					
							$("#success").modal('hide');
							location.reload();
						},1000);
					}
				},
				error: function (e) {
					console.log(e);
				}
			});
		}
	}
	
	//删除所选
	function deleteIn(str){
		$.ajax({
			type: "post",
			url: '/index/account/del_income',
			dataType: "json",
			data: {del:str},
			cache: true,
			async: false,
			success: function (msg) {
				if(msg.success){
					$("#success").modal({backdrop:false});
					setTimeout(function(){					
						$("#success").modal('hide');
						location.reload();
					},1000);
				}
			},
			error: function (e) {
				console.log(e);
			}
		});
	}
	
	//验证金钱
	function vali_money(){
		var money = $("#money").val();
		var floatNumReg = /^[0-9]+([.]{1}[0-9]+){0,1}$/;
		if(money==""){
			$("#money").attr('data-content','空或无效字符');
			$("#money").popover('show');
			setTimeout(function(){					
				$("#money").popover('hide');
			},500);
			return false;
		}
		if(!floatNumReg.test(money)){
			$("#money").attr('data-content','格式错误');
			$("#money").popover('show');
			setTimeout(function(){					
				$("#money").popover('hide');
			},500);
			return false;
		}
		$("#money").val(Number(money).toFixed(2));
		return true;
	}
	
	//验证时间
	function vali_time(){
		var time = $("#time").val();
		if(time==""){
			$("#time").attr('data-content','时间不能为空');
			$("#time").popover('show');
			setTimeout(function(){					
				$("#time").popover('hide');
			},500);
			return false;
		}
		return true;
	}
	
	//验证备注
	function vali_remark(){
		var remark = $("#remark").val();
		if(remark!="" && remark.length>40){
			$("#remark").attr('data-content','备注最多40字');
			$("#remark").popover('show');
			setTimeout(function(){					
				$("#remark").popover('hide');
			},500);
			return false;
		}
		return true;
	}
	
	//构建datatable
	function buildTable(){
		//请求income表数据记录
		var income_data = new Array();
		$.ajax({
			type: "get",
			url: '/index/account/get_income',
			async: false,
			success: function (msg) {
				income_data = msg.data;
			},
			error: function (e) {
				console.log(e);
			}
		});
		var table = $('#example').DataTable({
			"dom": '<"toolbar">lfrtip<"clear">',
			"lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
			data:income_data,
			"scrollX": true,
			"pagingType":   "full_numbers",
			"language": {
				"url": "/dist/i18n/Chinese.json"
			},
			"ordering": false, // 禁止排序
			"footerCallback": function ( row, data, start, end, display ) {
				var api = this.api(), data;
				var intVal = function ( i ) {
					return typeof i === 'string' ?
						i.replace(/[\￥,]/g, '')*1 :
						typeof i === 'number' ?
							i : 0;
				};
				total = api
					.column( 4 )
					.data()
					.reduce( function (a, b) {
						return intVal(a) + intVal(b);
					} );
				pageTotal = api
					.column( 4, { page: 'current'} )
					.data()
					.reduce( function (a, b) {
						return intVal(a) + intVal(b);
					}, 0 );
				$( api.column( 4 ).footer() ).html(
					'本页收入：￥'+pageTotal +' ( 共收入：￥'+ total +')'
				);
			},
			initComplete: function () {
				var api = this.api();
				api.columns().indexes().flatten().each( function ( i ) {
					var column = api.column( i );
					var select = $('<select class="form-control select"><option value=""></option></select>')
						.appendTo( $(column.header()).empty() )
						.on( 'change', function () {
							var val = $.fn.dataTable.util.escapeRegex(
								$(this).val()
							);
							column
								.search( val ? '^'+val+'$' : '', true, false )
								.draw();
						} );
					column.data().unique().sort().each( function ( d, j ) {
						if(d===null || d===""){
							return true;
						}
						select.append( '<option value="'+d+'">'+d+'</option>' )
					} );
				} );
			}
		}).on( 'init.dt', function () {	
			$(".dataTables_length").css("display","inline-block");
			$(".dataTables_filter").css("display","inline-block");
			$(".dataTables_info").css("display","inline-block");
			$(".dataTables_paginate").css("display","inline-block");
			$(".dataTables_paginate").css("float","right");
			$(".dataTables_filter").css("float","right");
			$(".dataTables_length label select").css("padding","0px");
			$(".dataTables_length label select").css("height","26px");
			$(".dataTables_length label select").css("width","55px");
			$(".toolbar").addClass('toolbar');
			$(".toolbar").html('<button id="delete" type="button" class="btn btn-danger  btn-xs"><i class="fa fa-trash-o"></i> 删除所选</button>');
			$('#delete').click( function () {
				if($("#example tbody ").find('.danger').length === 0 ){
					alert("请选择需要删除的项");
				}else{
					var deleteStr = "";
					$("#example tbody ").find('.danger').each(function ( l, o ) {
						let td = $(o).find('td')[0];
						deleteStr += $(td).html()+",";							
					});
					deleteStr=deleteStr.substring(0,deleteStr.length-1);
					deleteIn(deleteStr);
				}
				
			} );
		});
		
		$('#example tbody').on( 'click', 'tr', function () {
			$(this).toggleClass('danger');
		});
	}
</script>